# Создание собственного модуля

## Введение
Команда Юпи! активно развивает систему и внедряет новые возможности, но надо признать, что мы не всесильны и не можем удовлетворить потребностей всех пользователей. В этой главе мы постараемся максимально подробно осветить вопрос создания собственных модулей для Юпи!, чтобы вы могли самостоятельно улучшить свой проект или может даже разместить модуль в нашем [Маркете](http://yupe.ru/marketplace).

Если вы не знакомы с фреймворком [Yii](http://yiiframework.ru/doc/guide/ru/quickstart.what-is-yii), то для более легкого понимания материала, рекомендую вам ознакомиться с шаблоном проектирования [MVC](http://yiiframework.ru/doc/guide/ru/basics.mvc), [модулями](http://yiiframework.ru/doc/guide/ru/basics.module) фреймворка, а еще лучше - изучить учебное пособие по [созданию блога](http://yiiframework.ru/doc/blog/ru/start.overview).

## Описание модуля
Поскольку нашей задачей является обучение, а не изобретение чего-то нового и интересного, то мы будем создавать простенький модуль задач "ToDo". Думаю, для наших целей этого будет достаточно.
Дабы не усложнять процесс, сделаем допущение, что в системе может быть зарегистрирован только один пользователь. Это позволит нам не разделять списки задач. В качестве домашнего задания вы можете реализовать эту возможность самостоятельно.

Все этапы разработки будут оформлены в отдельные коммиты, которые вы сможете посмотреть на [GitHub](https://github.com/sabian/yupe-todo).
Возникшие вопросы можно задать на нашем [форуме](http://yupe.ru/talk/).

##### Список требований:
**backend**
- должна быть возможность создавать, редактировать и удалять задачи;
- реализовать поиск по задачам и фильтрацию по статусу;
- inline-редактирование статусов задач;
- изменение приоритета задач перетаскиванием мышью (drag&drop);
- на главной странице панели управления отображать уведомления о количестве невыполненных задач.

**frontend**
- создать страницу со списком задач и предоставить возможность пометить задачу как выполненную;
- сделать виджет, отображающий активные задачи, и разместить кнопку для перехода на страницу редактирования.

Да, можно сделать всё гораздо проще, но нам бы хотелось охватить как можно больше различных аспектов создания модуля.

## Каркас модуля
Сначала нужно создать минимально возможную структуру модуля, для того, чтобы можно было включить его в панели управления и визуально наблюдать изменения в процессе его создания. 
>Для большего понимания материала, мы не будем использовать генератор кода (Gii), а создадим каждый файл и директорию вручную. Конечно, в будущем вы можете использовать его для упрощения работы. Прочитать как это сделать, можно [здесь](http://yupe.ru/docs/module.create.html).

Дальнейшие действия подразумевают, что у вас установлена последняя стабильная версия Юпи! и открыт любимый редактор кода с добавленными в проект файлами системы.

В `protected/modules` создаем директорию `todo` для нашего модуля. Все дальнейшие действия будут проводиться внутри этой категории. 

Создаем основной файл модуля `TodoModule.php` с одноименным классом, расширяющим компонент `WebModule` модуля `yupe`.

```php
use yupe\components\WebModule;

class TodoModule extends WebModule 
{
    
}
```

И добавляем в него методы:

**getDependencies** - возвращает массив модулей, от которых будет зависеть наш модуль. Допустим, если бы мы хотели добавить комментарии к нашим задачам и возможность добавления изображений, то нужно было бы написать так:
```php
return ['image', 'comment'];
```
Наш модуль вполне самостоятелен, поэтому мы вернем пустой массив.

**getVersion** - возвращает версию вашего модуля для отображения в панели управления.

**getCategory** - сообщает системе в какой вкладке меню, панели управления, отображать меню нашего модуля. Т.е., если мы хотим разместить его в меню "Контент", то так и напишем:
```php
return 'Контент';
```

**getName** - возвращает название модуля.

**getDescription** - краткое описание модуля.

**getAuthor** - имя автора или компании, создавшей модуль.

**getAuthorEmail** - email-адрес.

**getUrl** - ссылка на сайт автора или на демонстрационный сайт.

**getIcon** - иконка модуля. Указывается в формате `fa fa-fw <название>`. Выбрать подходящую иконку и узнать ее название можно на сайте [FontAwesome](https://fortawesome.github.io/Font-Awesome/icons/). В этом модуле используем иконку [thumb-tack](http://fortawesome.github.io/Font-Awesome/icon/thumb-tack/), значит метод должен вернуть строку `fa fa-fw fa-thumb-tack`.

**getAdminPageLink** - здесь указывается ссылка на какую-либо страницу (чаще главную) модуля. Она нужна для отображения кнопки модуля на главной странице панели управления. Строится она по следующему правилу: `/<название модуля>/<название контроллера>/<действие>`. Для модуля она примет такой вид: `/todo/todoBackend/index`.

**getNavigation** - сообщает системе о структуре меню модуля. Он крайне простой, поэтому сделаем только два пункта: просмотр списка задач и создание задачи.
```php
return [
    [
        'icon'  => 'fa fa-fw fa-list-alt',
        'label' => 'Список задач',
        'url'   => ['/todo/todoBackend/index']
    ],
    [
        'icon'  => 'fa fa-fw fa-plus-square',
        'label' => 'Создать задачу',
        'url'   => ['/todo/todoBackend/create']
    ],
];
```
Эти данные будут использованы для генерации главного меню панели управления.

Осталось создать еще один файл и мы сможем установить модуль, чтобы потом, добавляя функционал, можно было наблюдать за изменениями в панели управления.

Создаем директорию `install`, в которой размещаем файл с точно таким же названием, как и модуль - `todo.php`. В нем будет храниться конфигурация модуля, где, для начала, мы просто сообщим системе о его существовании:
```php
return [
    'module'    => [
        'class' => 'application.modules.todo.TodoModule',
    ],
];
```
Строчка `application.modules.todo.TodoModule` - это путь до главного класса модуля, где `application` указывает на директорию `protected`. 

Вот и все! Если все сделано правильно, то в разделе "Модули", во вкладке "Не установлен!", мы должны увидеть наш модуль.
![Модуль ToDo](img/yupe-module-1.png)

После установки модуля вы должны увидеть пункт "ToDo" в главном меню и кнопку на главной странице панели управления.
![Установленный модуль ToDo](img/yupe-module-2.png)

И, хотя в нем еще ничего не отображается, кроме названия и меню модуля, а впереди нас ждет еще уйма работы, я думаю, можно вас поздравить с этим маленьким, но очень важным шагом.

Детально изучить созданные файлы вы можете в [этом коммите на GitHub](https://github.com/sabian/yupe-todo/commit/4ee5d8b316279d2c27c5a536b7fd4033be94db01). А если возникли вопросы, то смело задавайте их на нашем [форуме](http://yupe.ru/talk/). Будем рады помочь!

## Миграции
Теперь пришло время задуматься над структурой таблицы модуля и создании миграции. О том, что такое миграции, для чего они нужны и как с ними работать, вы можете прочитать в [официальном руководстве](http://yiiframework.ru/doc/guide/ru/database.migration).

В модулях Юпи! файлы миграций хранятся в директории `install/migrations`. Перед тем как продолжать, убедитесь, что вы ее создали.

Далее, в консоли, находясь в корневой папке вашего проекта, выполняем команду `php protected/yiic migrate create todo yupe_todo_table`. Этой командой мы создаем файл миграции `yupe_todo_table` для модуля `todo`. 

Если все прошло хорошо, то на данный момент у вас должна быть следующая структура директорий:

```
.
├── install
│   ├── migrations
│   │   └── m151205_141508_yupe_todo_table.php
│   └── todo.php
├── LICENSE
├── README.md
└── TodoModule.php
```

Теперь, в созданном файле, нужно описать поля таблицы для хранения задач. 
Согласно, описанным выше, требованиям к модулю, у задачи должно быть описание, статус и сортировка.

```php
class m151205_141508_yupe_todo_table extends yupe\components\DbMigration
{
    public function safeUp()
    {
        $this->createTable('{{todo}}', [
            'id' => 'pk',
            'description' => 'string NOT NULL',
            'status' => 'TINYINT(1) NOT NULL DEFAULT 1',
            'sort' => 'integer NOT NULL DEFAULT 1',
        ], $this->getOptions());
    }

    public function safeDown()
    {
        $this->dropTable('{{todo}}');
    }
}
```

Обратите внимание, что название таблицы заключено в двойные фигурные скобки `{{todo}}`. Это сделано для того, чтобы система автоматически подставила префикс для таблиц, который задается на этапе установки. Если вы ничего не меняли, то после применения миграции в базе данных должна появиться таблица `yupe_todo`.

Метод `getOptions` добавляет параметры таблицы: `ENGINE=InnoDB DEFAULT CHARSET=utf8`

Осталось только ввести команду `php protected/yiic migrate --module=todo` и подтвердить что хотите применить миграцию.

После успешного завершения операции, в базе данных должна появиться таблица со следующей структурой:

```
+-------------+--------------+------+-----+---------+----------------+
| Field       | Type         | Null | Key | Default | Extra          |
+-------------+--------------+------+-----+---------+----------------+
| id          | int(11)      | NO   | PRI | NULL    | auto_increment |
| description | varchar(255) | NO   |     | NULL    |                |
| status      | tinyint(1)   | NO   |     | 1       |                |
| sort        | int(11)      | NO   |     | 1       |                |
+-------------+--------------+------+-----+---------+----------------+
```

Результат на [GitHub](https://github.com/sabian/yupe-todo/commit/7feff834d603f30d86debccd151738145243455e)

## Модель
Учитывая что официальное руководство по Yii фреймворку предоставляет исчерпывающую информацию о [моделях](http://yiiframework.ru/doc/guide/ru/basics.model), их [создании](http://yiiframework.ru/doc/guide/ru/form.model) и [работе с базой данных](http://yiiframework.ru/doc/guide/ru/database.overview), нет смысла здесь повторяться, а лучше сразу перейти к делу.

В Юпи! есть базовый класс `YModel` от которого должны быть унаследованы все модели. Исходя из этого определяем класс:
```php
use yupe\models\YModel;

class Todo extends YModel
{
    
}
```

На этом этапе понадобится переопределить только три метода:
- **tableName** - возвращает название таблицы в базе данных. Здесь все просто, это будет строка `{{todo}};
- **rules** - правила валидации данных;
- **attributeLabels** - возвращает список меток аттрибутов в формате `'Атрибут' => 'Описание'`.

Все остальное будем дописывать при первой необходимости.

Посмотреть на получившийся код вы можете в соответствующем коммите на GitHub, ссылка на который указана в конце этого раздела.
А пока опишем требования для правил валидации:
- поле `description` должно быть обязательным и иметь длину не боллее 255 символов;
- поля `status` и `sort` должны быть целочисленными.

```php
['description', 'required'],
['description', 'length', 'max' => 255],
['status, sort', 'numerical', 'integerOnly' => true],
```

Пока это все, что мы можем написать в модели. В дальнейшем придется добавить несколько правил валидации и методов, а пока можно изучить [полученный результат](https://github.com/sabian/yupe-todo/commit/6330d8a7ec06a8dd86976b10514cce34df571ce0).

## Backend
Если у вас возникли вопросы по предыдущим шагам руководства, то можете смело задавать их на [форуме](http://yupe.ru/talk/). Возможно это поможет нам дополнить руководство и сделать его более понятным.

На этом этапе, пожалуй самым логичным будет создание административной части модуля. Начнем с контроллера.

В методе `getNavigation` (файл TodoModule.php) ссылки на пункты меню имеют следующий вид: `['/todo/todoBackend/index']`. Как уже говорилось ранее, они создаются по принципу `/название модуля/название контроллера/действие`. Из этого следует, что контроллер должен называться `TodoBackendController` и располагаться в директории `controllers`. 

К этому моменту структура директорий модуля должна иметь вид:

```
.
├── controllers
│   └── TodoBackendController.php
├── install
│   ├── migrations
│   │   └── m151205_141508_yupe_todo_table.php
│   └── todo.php
├── LICENSE
├── models
│   └── Todo.php
├── README.md
└── TodoModule.php
```

Обратите внимание, что контроллер должен наследовать `BackController`. Также создаем действие `index` в котором задаем отображение одноименного представления.

```php
use yupe\components\controllers\BackController;

class TodoBackendController extends BackController
{
    public function actionIndex()
    {
        $this->render('index');
    }
}
```

Файлы представлений должны находиться в директории `views`, внутри которой они сортируются по директориям относящимся к конкретному контроллеру. В данном случае это `todoBackend`. Создаем файл и оставляем его пока пустым.

Для тех, кто не уверен, что правильно все понял, размещаем структуру категорий которая должна быть после создания файла представления.

```
.
├── controllers
│   └── TodoBackendController.php
├── install
│   ├── migrations
│   │   └── m151205_141508_yupe_todo_table.php
│   └── todo.php
├── LICENSE
├── models
│   └── Todo.php
├── README.md
├── TodoModule.php
└── views
    └── todoBackend
        └── index.php
```

Если все сделано правильно, то на этот момент при клике на пункте меню `Контент - ToDo` в панели управления, не должно появляться ошибки, как это было ранее. Вы должны увидеть главное меню панели управления, блок с информацией о модуле и пустую контентную область.

#### Отображение списка задач и фильтрация
Отвечать за отображение списка задач будет виджет [CustomGridView](https://github.com/yupe/yupe/blob/master/protected/modules/yupe/widgets/CustomGridView.php), которому нужен источник данных. Для этого будет использоваться [CActiveDataProvider](http://www.yiiframework.com/doc/api/1.1/CActiveDataProvider).

Теперь в модели (файл `models/Todo.php`) необходимо создать метод `search`, который и будет служить источником данных для отображения и фильтрации задач.

```php
public function search()
{
    $criteria = new CDbCriteria;

    $criteria->compare('description', $this->description, true);
    $criteria->compare('status', $this->status);

    return new CActiveDataProvider(get_class($this), [
        'criteria' => $criteria,
        'sort' => [
            'defaultOrder' => 'sort'
        ]
    ]);
}
```

Приведенный выше код не должен вызывать трудностей. Стоит только уделить немного внимания этим двум строкам:

```php
$criteria->compare('description', $this->description, true);
$criteria->compare('status', $this->status);
```

Здесь описываются условия для фильтрации данных, из которых можно понять, что поиск будет осуществляться только по двум полям: `description` и `status`. При этом для поля `description` третьим параметром передается `true`, что сообщает системе о возможности частичного совпадения фразы.

Для правильной работы поиска, в правилах валидации (метод `rules`), необходимо объявить эти поля безопасными для сценария `search`:

```php
['description, sort', 'safe', 'on' => 'search']
```

Теперь нужно изменить контроллер:

```php
public function actionIndex()
{
    // В модели включаем сценарий search
    $model = new Todo('search');

    // Получаем данные из запроса. 
    // Если в фильтре ничего не меняли, то в переменной будет null
    $query = Yii::app()->getRequest()->getQuery('Todo');

    $model->unsetAttributes();

    if ($query) {
        // Присваиваем атрибутам модели значения из запроса
        $model->setAttributes($query);
    }
    
    // Передаем модель в представление
    $this->render('index', ['model' => $model]);
}
```

А в представлении добавить виджет:

```php
$this->widget('yupe\widgets\CustomGridView', [
        'id' => 'todo-grid',
        'type' => 'condensed',
        'dataProvider' => $model->search(),
        'filter' => $model,
        'columns' => [
            'id',
            'description',
            'status',
            [
                'class' => 'yupe\widgets\CustomButtonColumn',
                'template' => '{update} {delete}'
            ],
        ],
    ]
);
```

Теперь, в панели управления, вы должны увидеть следующую картину:

![Модуль ToDo - Список](img/yupe-module-3.png)

Обращаем ваше внимание на то, что не весь код размещается в этом описании, а только самые важные его части. Более подробно изучить код этой части можно на [GitHub](https://github.com/sabian/yupe-todo/commit/f4d2019ff395c625857935a615bb2d2c1815926d).

-----------
**План работы** (это для себя и не войдет в доки):
- ~~создание каркаса модуля (только основные файлы, чтобы можно было включить в админке и увидеть меню). Для наглядности сделать какие-нибудь параметры, чтобы можно было редактировать через настройки.~~
- ~~Продумывание структуры БД, создание миграций и их применение.~~
- ~~создание модели и переводов~~
- CRUD
- инлайн редактирование статусов
- D&D сортировка
- поиск и фильтрация
- уведомления о невыполненных задачах на главной
- Контроллер на фронте с гридом задач (здесь можно написать еще про хлебные крошки и сео-теги)
- реализация действия кнопки "Выполнено"
- создание виджета и размещение его в сайдбаре.